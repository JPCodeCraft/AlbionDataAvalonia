# Automated build and release workflow for AlbionDataAvalonia
name: Build and Release

on:
  workflow_dispatch:
  push:
    branches:
      - release/macos-signing
    paths:
      - '.github/workflows/publish.yml'

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Publish macOS project (x64)
        run: |
          dotnet publish ./AlbionDataAvalonia.Desktop.MacOS/AlbionDataAvalonia.Desktop.MacOS.csproj --configuration Release -r osx-x64

      - name: Publish macOS project (arm64)
        run: |
          dotnet publish ./AlbionDataAvalonia.Desktop.MacOS/AlbionDataAvalonia.Desktop.MacOS.csproj --configuration Release -r osx-arm64

      - name: Import Apple Developer ID certificate (temp keychain)
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$DEVELOPER_ID_CERT_BASE64" | base64 --decode > dev_id.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import dev_id.p12 -k build.keychain -P "$DEVELOPER_ID_CERT_PASSWORD" -T /usr/bin/codesign
          # Allow codesign and Xcode tools to access the key without UI prompts
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security list-keychains -d user -s build.keychain login.keychain
          security find-identity -p codesigning -v

      - name: Codesign macOS app (x64)
        env:
          DEVELOPER_ID_IDENTITY: ${{ secrets.DEVELOPER_ID_IDENTITY }}
        run: |
          APP_DIR="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS.app"
          codesign --force --deep --options runtime --entitlements packaging/macos/entitlements.plist --timestamp -s "$DEVELOPER_ID_IDENTITY" "$APP_DIR"
          codesign -dv --verbose=4 "$APP_DIR" || true

      - name: Codesign macOS app (arm64)
        env:
          DEVELOPER_ID_IDENTITY: ${{ secrets.DEVELOPER_ID_IDENTITY }}
        run: |
          APP_DIR="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS.app"
          codesign --force --deep --options runtime --entitlements packaging/macos/entitlements.plist --timestamp -s "$DEVELOPER_ID_IDENTITY" "$APP_DIR"
          codesign -dv --verbose=4 "$APP_DIR" || true

      - name: Zip apps for notarization
        run: |
          APP_DIR_X64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS.app"
          ZIP_PATH_X64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS_x64.app.zip"
          ditto -c -k --sequesterRsrc --keepParent "$APP_DIR_X64" "$ZIP_PATH_X64"

          APP_DIR_ARM64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS.app"
          ZIP_PATH_ARM64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS_arm64.app.zip"
          ditto -c -k --sequesterRsrc --keepParent "$APP_DIR_ARM64" "$ZIP_PATH_ARM64"

      - name: Submit x64 to notarization
        env:
          AC_API_KEY_ID: ${{ secrets.AC_API_KEY_ID }}
          AC_API_ISSUER_ID: ${{ secrets.AC_API_ISSUER_ID }}
          AC_API_KEY_P8_BASE64: ${{ secrets.AC_API_KEY_P8_BASE64 }}
        run: |
          echo "$AC_API_KEY_P8_BASE64" | base64 --decode > AuthKey.p8
          ZIP_PATH="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS_x64.app.zip"
          echo "Submitting x64 to Apple notarization..."
          xcrun notarytool submit "$ZIP_PATH" --key AuthKey.p8 --key-id "$AC_API_KEY_ID" --issuer "$AC_API_ISSUER_ID" 2>&1 | tee notarize_result_x64.txt
          echo "Notarization submission complete for x64."

      - name: Submit arm64 to notarization
        env:
          AC_API_KEY_ID: ${{ secrets.AC_API_KEY_ID }}
          AC_API_ISSUER_ID: ${{ secrets.AC_API_ISSUER_ID }}
        run: |
          ZIP_PATH="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS_arm64.app.zip"
          echo "Submitting arm64 to Apple notarization..."
          xcrun notarytool submit "$ZIP_PATH" --key AuthKey.p8 --key-id "$AC_API_KEY_ID" --issuer "$AC_API_ISSUER_ID" 2>&1 | tee notarize_result_arm64.txt
          echo "Notarization submission complete for arm64."

      - name: Extract notarization Submission IDs
        run: |
          SUBMISSION_ID_X64=$(sed -n 's/^[[:space:]]*id:[[:space:]]*\(.*\)$/\1/p' notarize_result_x64.txt | head -n1)
          if [ -z "$SUBMISSION_ID_X64" ]; then
            echo "Failed to parse x64 Submission ID"; cat notarize_result_x64.txt; exit 1;
          fi
          echo "SUBMISSION_ID_X64=$SUBMISSION_ID_X64" >> "$GITHUB_ENV"
          echo "x64 Submission ID: $SUBMISSION_ID_X64"

          SUBMISSION_ID_ARM64=$(sed -n 's/^[[:space:]]*id:[[:space:]]*\(.*\)$/\1/p' notarize_result_arm64.txt | head -n1)
          if [ -z "$SUBMISSION_ID_ARM64" ]; then
            echo "Failed to parse arm64 Submission ID"; cat notarize_result_arm64.txt; exit 1;
          fi
          echo "SUBMISSION_ID_ARM64=$SUBMISSION_ID_ARM64" >> "$GITHUB_ENV"
          echo "arm64 Submission ID: $SUBMISSION_ID_ARM64"

      - name: Wait for x64 notarization result
        env:
          AC_API_KEY_ID: ${{ secrets.AC_API_KEY_ID }}
          AC_API_ISSUER_ID: ${{ secrets.AC_API_ISSUER_ID }}
        run: |
          ATTEMPTS=60
          SLEEP_SECS=30
          STATUS=""
          MAX_WAIT=$((ATTEMPTS * SLEEP_SECS))
          echo "Will wait up to $MAX_WAIT seconds for x64 notarization..."
          for i in $(seq 1 $ATTEMPTS); do
            ELAPSED=$((i * SLEEP_SECS))
            echo "[${ELAPSED}s/$MAX_WAIT] Polling x64 notarization status (attempt $i/$ATTEMPTS)..."
            xcrun notarytool info "$SUBMISSION_ID_X64" --key AuthKey.p8 --key-id "$AC_API_KEY_ID" --issuer "$AC_API_ISSUER_ID" 2>&1 | tee notary_info_x64.txt || true
            STATUS=$(sed -n 's/^[[:space:]]*status:[[:space:]]*\(.*\)$/\1/p' notary_info_x64.txt | tr 'A-Z' 'a-z' | head -n1)
            echo "Status: ${STATUS:-unknown}"
            if echo "$STATUS" | grep -q '^accepted'; then
              echo "✓ x64 Accepted by Apple after $ELAPSED seconds"; break;
            fi
            if echo "$STATUS" | grep -q '^invalid'; then
              echo "✗ x64 Invalid submission. Fetching detailed log..."
              xcrun notarytool log "$SUBMISSION_ID_X64" --key AuthKey.p8 --key-id "$AC_API_KEY_ID" --issuer "$AC_API_ISSUER_ID" | tee notary_log_x64.txt
              exit 1
            fi
            if [ $i -lt $ATTEMPTS ]; then
              echo "Waiting ${SLEEP_SECS}s before next check..."
              sleep $SLEEP_SECS
            fi
          done
          if ! echo "$STATUS" | grep -q '^accepted'; then
            echo "✗ Timed out waiting for x64 notarization approval"; exit 1;
          fi

      - name: Wait for arm64 notarization result
        env:
          AC_API_KEY_ID: ${{ secrets.AC_API_KEY_ID }}
          AC_API_ISSUER_ID: ${{ secrets.AC_API_ISSUER_ID }}
        run: |
          ATTEMPTS=60
          SLEEP_SECS=30
          STATUS=""
          MAX_WAIT=$((ATTEMPTS * SLEEP_SECS))
          echo "Will wait up to $MAX_WAIT seconds for arm64 notarization..."
          for i in $(seq 1 $ATTEMPTS); do
            ELAPSED=$((i * SLEEP_SECS))
            echo "[${ELAPSED}s/$MAX_WAIT] Polling arm64 notarization status (attempt $i/$ATTEMPTS)..."
            xcrun notarytool info "$SUBMISSION_ID_ARM64" --key AuthKey.p8 --key-id "$AC_API_KEY_ID" --issuer "$AC_API_ISSUER_ID" 2>&1 | tee notary_info_arm64.txt || true
            STATUS=$(sed -n 's/^[[:space:]]*status:[[:space:]]*\(.*\)$/\1/p' notary_info_arm64.txt | tr 'A-Z' 'a-z' | head -n1)
            echo "Status: ${STATUS:-unknown}"
            if echo "$STATUS" | grep -q '^accepted'; then
              echo "✓ arm64 Accepted by Apple after $ELAPSED seconds"; break;
            fi
            if echo "$STATUS" | grep -q '^invalid'; then
              echo "✗ arm64 Invalid submission. Fetching detailed log..."
              xcrun notarytool log "$SUBMISSION_ID_ARM64" --key AuthKey.p8 --key-id "$AC_API_KEY_ID" --issuer "$AC_API_ISSUER_ID" | tee notary_log_arm64.txt
              exit 1
            fi
            if [ $i -lt $ATTEMPTS ]; then
              echo "Waiting ${SLEEP_SECS}s before next check..."
              sleep $SLEEP_SECS
            fi
          done
          if ! echo "$STATUS" | grep -q '^accepted'; then
            echo "✗ Timed out waiting for arm64 notarization approval"; exit 1;
          fi

      - name: Staple and validate apps
        run: |
          APP_DIR_X64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS.app"
          xcrun stapler staple "$APP_DIR_X64"
          spctl -a -vv "$APP_DIR_X64" || true

          APP_DIR_ARM64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS.app"
          xcrun stapler staple "$APP_DIR_ARM64"
          spctl -a -vv "$APP_DIR_ARM64" || true

      - name: Re-zip stapled apps for distribution
        run: |
          APP_DIR_X64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS.app"
          ZIP_PATH_X64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS_x64.app.zip"
          rm -f "$ZIP_PATH_X64"
          ditto -c -k --sequesterRsrc --keepParent "$APP_DIR_X64" "$ZIP_PATH_X64"

          APP_DIR_ARM64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS.app"
          ZIP_PATH_ARM64="./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS_arm64.app.zip"
          rm -f "$ZIP_PATH_ARM64"
          ditto -c -k --sequesterRsrc --keepParent "$APP_DIR_ARM64" "$ZIP_PATH_ARM64"

      - name: Upload macOS artifact (x64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-x64
          path: ./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS_x64.app.zip

      - name: Upload macOS artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-arm64
          path: ./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS_arm64.app.zip

  build:
    runs-on: windows-latest
    needs: build-macos

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get the version
        id: get_version
        run: |
          $version = (Select-String -Path ./AlbionDataAvalonia.Desktop/pkg/inno.iss -Pattern '#define MyAppVersion "(.*)"').Matches.Groups[1].Value
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "Found version: $version"
        shell: pwsh

      - name: Get diff
        id: get_diff
        run: |
          git fetch --tags
          # Try to get latest tag, but don't fail if none exists
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          CURRENT_COMMIT=$(git rev-parse HEAD)
          REPO_URL="https://github.com/JPCodeCraft/AlbionDataAvalonia"

          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found. Using all commits for the log."
            # Get all commits or limit to a reasonable number
            COMMIT_LOG=$(git log --max-count=20 --pretty=format:"[%h]($REPO_URL/commit/%H) - %s")
          else
            echo "Found tag: $LATEST_TAG"
            COMMIT_LOG=$(git log --pretty=format:"[%h]($REPO_URL/commit/%H) - %s" $LATEST_TAG..$CURRENT_COMMIT)
            if [ -z "$COMMIT_LOG" ]; then
              COMMIT_LOG="No new commits since the last release."
            fi
          fi

          COMMIT_LOG=${COMMIT_LOG//$'\n'/<br>}
          echo "Latest Tag: ${LATEST_TAG:-None}"
          echo "Current Commit: $CURRENT_COMMIT"
          echo "Commit Log: $COMMIT_LOG"
          echo "COMMIT_LOG=$COMMIT_LOG" >> $GITHUB_ENV
        shell: bash

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Install zip
        run: choco install zip -y
        shell: pwsh

      - name: Publish projects (Windows and Linux)
        run: |
          dotnet publish ./AlbionDataAvalonia.Desktop/AlbionDataAvalonia.Desktop.csproj --configuration Release
          dotnet publish ./AlbionDataAvalonia.Desktop.Linux/AlbionDataAvalonia.Desktop.Linux.csproj --configuration Release

      - name: Download macOS artifact (x64)
        uses: actions/download-artifact@v4
        with:
          name: macos-app-x64
          path: AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish

      - name: Download macOS artifact (arm64)
        uses: actions/download-artifact@v4
        with:
          name: macos-app-arm64
          path: AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish

      - name: Compile .ISS to .EXE Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: AlbionDataAvalonia.Desktop/pkg/inno.iss
          options: /O+

      - name: Create Tag
        id: create_tag
        run: |
          git tag v.${{ env.VERSION }}
          git push origin v.${{ env.VERSION }}
        shell: pwsh

      - name: Create Release and Upload Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_LOG: ${{ env.COMMIT_LOG }}
        run: |
          cat > release_notes.txt << 'EOF'
          Changes since last release:
          EOF
          echo "$COMMIT_LOG" >> release_notes.txt
          gh release create "v.${{ env.VERSION }}" \
            "C:/Users/runneradmin/Documents/Inno Setup Output/AFMDataClientSetup_v_${{ env.VERSION }}.exe#AFMDataClientSetup_v_${{ env.VERSION }}.exe" \
            "./AlbionDataAvalonia.Desktop.Linux/bin/Release/net10.0/linux-x64/publish/AFMDataClient_Linux64#AFMDataClient_Linux64" \
            "./AlbionDataAvalonia.Desktop.Linux/bin/Release/net10.0/linux-x64/publish/AFMDataClient_Linux64_Installer.sh#AFMDataClient_Linux64_Installer.sh" \
            "./AlbionDataAvalonia.Desktop.Linux/bin/Release/net10.0/linux-x64/publish/AFMDataClient_Linux64_Uninstaller.sh#AFMDataClient_Linux64_Uninstaller.sh" \
            "./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-x64/publish/AFMDataClient_MacOS_x64.app.zip#AFMDataClient_MacOS_x64.app.zip" \
            "./AlbionDataAvalonia.Desktop.MacOS/bin/Release/net10.0/osx-arm64/publish/AFMDataClient_MacOS_arm64.app.zip#AFMDataClient_MacOS_arm64.app.zip" \
            --title "Albion Free Market Data Client v.${{ env.VERSION }}" \
            --notes-file release_notes.txt
        shell: bash

      - name: Create LatestVersion.json
        run: |
          $version = "${{ env.VERSION }}"
          $json = @{ version = $version } | ConvertTo-Json
          $json | Out-File -FilePath ./AlbionDataAvalonia.Desktop/LatestVersion.json -Encoding utf8
        shell: pwsh

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ./AlbionDataAvalonia.Desktop/LatestVersion.json
          git commit -m "Update LatestVersion.json"
          git push
