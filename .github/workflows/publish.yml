name: Build and Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:

        - name: Checkout code
          uses: actions/checkout@v4
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
          
        - name: Get the version
          id: get_version
          run: |
            $version = (Select-String -Path ./AlbionDataAvalonia.Desktop/pkg/inno.iss -Pattern '#define MyAppVersion "(.*)"').Matches.Groups[1].Value
            echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            echo "Found version: $version"
          shell: pwsh

        - name: Setup .NET
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: '7.0.x' 

        - name: Build project
          run: |
            dotnet build ./AlbionDataAvalonia.Desktop/AlbionDataAvalonia.Desktop.csproj --configuration Release

        - name: Compile .ISS to .EXE Installer
          uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
          with:
            path: ./AlbionDataAvalonia.Desktop/pkg/inno.iss
            options: /O+

        - name: Get diff
          id: get_diff
          run: |
            git fetch --tags
            $LATEST_TAG = git describe --tags --abbrev=0 --always
            $DIFF = git diff --shortstat $LATEST_TAG
            echo "Latest Tag: $LATEST_TAG"
            echo "Diff: $DIFF"
            echo "DIFF=$DIFF" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          shell: pwsh

        - name: Create Release
          id: create_release
          uses: actions/create-release@v1
          env:
            GITHUB_TOKEN: ${{ secrets.AVALONIA_TOKEN }}
          with:
            tag_name: v.${{ env.VERSION }}
            release_name: Albion Free Market Data Client v.${{ env.VERSION }}
            body: |
              Changes since last release:
              ${{ env.DIFF }}
            draft: false
            prerelease: false

        - name: Upload Release Asset
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.AVALONIA_TOKEN }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: C:\Users\runneradmin\Documents\Inno Setup Output\AFMDataClientSetup_v_${{ env.VERSION }}.exe
            asset_name: AFMDataClientSetup_v_${{ env.VERSION }}.exe
            asset_content_type: application/octet-stream

        - name: Create LatestVersion.json
          run: |
            $version = "${{ env.VERSION }}"
            $json = @{ version = $version } | ConvertTo-Json
            $json | Out-File -FilePath ./AlbionDataAvalonia.Desktop/LatestVersion.json -Encoding utf8
          shell: pwsh

        - name: Commit and push changes
          run: |
              git add ./AlbionDataAvalonia.Desktop/LatestVersion.json
              git commit -m "Update LatestVersion.json"
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              git push
